# üö® Cloudflare 520 Resolution Report
**Date:** 2026-01-21  
**Environment:** PROD  
**Domain:** https://neighborgigs-bwm.zocomputer.io

---

## ‚úÖ Confirmed Root Cause

**Origin server was not running on port 58289**

### Proof

#### 1. Diagnostic Output (Before Fix)
```bash
bun scripts/520-diagnose.ts https://neighborgigs-bwm.zocomputer.io prod

# Results:
‚ùå Cannot reach origin on port 58289
‚ùå Connection refused
‚ùå 520 Error from Cloudflare
```

#### 2. Port Status Check
```bash
ss -tlnp | grep 58289
# Result: No process listening on port 58289
```

#### 3. Netstat Verification
```bash
ss -tlnp | grep 50430
# Result: DEV server running on port 50430 ‚úì
```

#### 4. Production Port Check (Before Fix)
```bash
curl -v http://localhost:58289/health
# Result: Connection refused
```

---

## üõ†Ô∏è Minimal Fix Applied

### 1. Stopped Old Processes
```bash
pkill -f "bun.*prod"
```

### 2. Started Production Server
```bash
cd /home/workspace/neighborgigs

NODE_ENV=production \
PORT=58289 \
SUPABASE_URL="https://ftgclimxdaufufagsmad.supabase.co" \
ZO_CLIENT_IDENTITY_TOKEN="none" \
nohup bun run prod > /dev/shm/prod.log 2>&1 &
```

### 3. Verified Server Start
```bash
tail -f /dev/shm/prod.log

# Result:
‚úì Build completed successfully
‚úì Started server: http://localhost:58289
```

### 4. Local Health Check
```bash
curl http://localhost:58289/health

# Result:
{"status":"ok","timestamp":"2026-01-21T16:07:56.852Z","environment":"production","service":"neighborgigs"}
```

### 5. Cloudflare Health Check
```bash
curl https://neighborgigs-bwm.zocomputer.io/health

# Result:
HTTP/2 200 OK
{"status":"ok","timestamp":"2026-01-21T16:14:42.030Z","environment":"production","service":"neighborgigs"}
```

---

## üìä Why Cloudflare Returned 520

**Cloudflare successfully connected to the origin, but the origin rejected the connection because no process was listening on the published port (58289).**

### What Happened:
1. ‚úÖ Cloudflare DNS resolved to the Zo server IP
2. ‚úÖ TLS handshake completed successfully
3. ‚úÖ Cloudflare opened TCP connection to port 58289
4. ‚ùå Connection refused (no process listening)
5. ‚ùå Cloudflare returned 520 (origin connection failure)

### What a 520 Means (Ground Truth):
```text
Cloudflare successfully connected to the origin,
but the origin returned:
- Connection refused
- No process listening on the port
```

---

## üîç Root Cause Analysis

### Why Did This Happen?

**The production server was not running.**

Looking at the deployment history:
- DEV server (port 50430) was running ‚úì
- Vite dev server (port 3000) was running ‚úì
- PROD server (port 58289) was NOT running ‚úó

### Possible Causes:
1. **Server crash** - The production server may have crashed after the last deploy
2. **Process termination** - The process may have been killed
3. **Deployment issue** - The deployment may not have restarted the service
4. **Port conflict** - Another process may have been using port 58289

### Evidence from Logs:
```bash
cat /dev/shm/prod.log
# Shows successful build and server start
```

The server started successfully when we manually started it, so it wasn't a build issue.

---

## üõ°Ô∏è Prevention Measures

### 1. Implement Health Check in Deployment
The new deployment script (`scripts/deploy.sh`) now includes:
- ‚úÖ Pre-deployment validation
- ‚úÖ Health check after starting
- ‚úÖ Header validation
- ‚úÖ Minimal endpoint tests
- ‚úÖ Post-deployment validation

### 2. Continuous Monitoring
The new health monitor (`scripts/health-monitor.ts`) can run:
```bash
bun scripts/health-monitor.ts prod 3600  # Monitor for 1 hour
```

### 3. Emergency Rollback Script
Created `scripts/emergency-rollback.sh` for instant rollback.

### 4. Required Steps Before Any Deploy:
1. **Check running processes:**
   ```bash
   ss -tlnp | grep 58289
   ```

2. **Start production server:**
   ```bash
   cd /home/workspace/neighborgigs
   NODE_ENV=production PORT=58289 nohup bun run prod > /dev/shm/prod.log 2>&1 &
   ```

3. **Verify health locally:**
   ```bash
   curl http://localhost:58289/health
   ```

4. **Wait for Cloudflare:**
   ```bash
   # Wait 30 seconds for DNS propagation
   curl https://neighborgigs-bwm.zocomputer.io/health
   ```

---

## üéØ Current Status

### Before Fix:
- ‚ùå 520 errors from Cloudflare
- ‚ùå Origin not responding
- ‚ùå Site inaccessible

### After Fix:
- ‚úÖ HTTP 200 from Cloudflare
- ‚úÖ Origin responding
- ‚úÖ Site accessible

### Endpoint Tests:
```bash
# Health endpoint
curl https://neighborgigs-bwm.zocomputer.io/health
# HTTP/2 200 OK ‚úì

# Root endpoint
curl https://neighborgigs-bwm.zocomputer.io/
# HTTP/2 200 OK ‚úì

# API endpoint
curl https://neighborgigs-bwm.zocomputer.io/api/hello-zo
# {"msg":"Hello from Zo"} ‚úì
```

---

## üìã Final Verification

```bash
# 1. Check server is running
ss -tlnp | grep 58289
# LISTEN 0 0 *:58289 *:* users:(("bun",pid=17020,fd=12)) ‚úì

# 2. Check health
curl -s http://localhost:58289/health
# {"status":"ok",...} ‚úì

# 3. Check through Cloudflare
curl -s https://neighborgigs-bwm.zocomputer.io/health
# {"status":"ok",...} ‚úì

# 4. Check logs
tail -n 20 /dev/shm/prod.log
# Shows successful operations ‚úì
```

---

## üö® Immediate Actions Required

### For Future Deploys:
1. **Always run deployment script:**
   ```bash
   ./scripts/deploy.sh prod
   ```

2. **Monitor during deploy:**
   ```bash
   bun scripts/health-monitor.ts prod 300
   ```

3. **If 520 detected:**
   ```bash
   ./scripts/emergency-rollback.sh
   ```

### For Monitoring:
- Run health monitor continuously: `bun scripts/health-monitor.ts prod 3600`
- Check logs: `tail -f /dev/shm/prod.log`
- Set up alerts for 520 errors

---

## üìö Related Documentation

1. **520 Diagnostic Flow**: `docs/CLOUDFLARE_520_DIAGNOSTIC.md`
2. **Emergency Response**: `docs/520_EMERGENCY_RESPONSE.md`
3. **Quick Reference**: `docs/CLOUDFLARE_520_QUICK_REFERENCE.md`
4. **Scripts Documentation**: `scripts/README.md`

---

## ‚úÖ Resolution Complete

**520 errors have been resolved by starting the production server on port 58289.**

The site is now accessible at: https://neighborgigs-bwm.zocomputer.io

**Root Cause:** Production server not running  
**Fix:** Started production server on port 58289  
**Prevention:** Implemented deployment validation and monitoring scripts
